name: qa-deployment
on:
  push:
#    branches:
#      - develop

jobs:
  build:
    uses: awesomemotive/Botiga/.github/workflows/build.yml@feature/394-modular-workflows

  deploy:
    runs-on: ubuntu-22.04
    needs: build
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.WPFORMS_TEST_DOCKER_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          chmod 700 ~/.ssh

      # This action exposes GitHub environment variables, making them available in subsequent steps.
      - name: GitHub Environment Variables Action
        uses: FranzDiebold/github-env-vars-action@v2.8.0

      # Sets a project name based on the GitHub repository name.
      # It extracts the repository name, converts it to lowercase, and saves it as an environment variable PROJECT_NAME.
      - name: Set Project Name
        run: |
          repo_full_name="${{ github.repository }}"
          repo_short_name="${repo_full_name##*/}"
          echo "PROJECT_NAME=${repo_short_name,,}" >> $GITHUB_ENV

      - name: Download artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.PROJECT_NAME }}
          path: ${{ env.PROJECT_NAME }}

      - name: Display structure of downloaded files
        run: ls -R

      - name: Upload to qa-botiga.athemes.wpfc.io
        run: |
          rsync --rsh="ssh -o StrictHostKeyChecking=no" \
             --ignore-times \
             --archive \
             --verbose \
             --compress \
             --human-readable \
             --progress \
             --whole-file \
             --remove-source-files \
             ${{ env.PROJECT_NAME }}.zip \
             qabotigaathemes@159.89.184.130:/sites/qa-botiga.athemes.wpfc.io/files/wp-content/themes/

      - name: Install on qa-botiga.athemes.wpfc.io
        run: |
          echo "Installing: ${{ env.PROJECT_NAME }}.zip"
          ssh qabotigaathemes@159.89.184.130 "cd /sites/qa-botiga.athemes.wpfc.io/files/wp-content/themes && rm -rf ${{ env.PROJECT_NAME }} && unzip ${{ env.PROJECT_NAME }}.zip && rm ${{ env.PROJECT_NAME }}.zip" < /dev/null